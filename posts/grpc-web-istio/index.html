<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Jackie Li"><meta name=description content="Expose GRPC & GRPC-Web via One Port in Istio"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="GRPC & GRPC-Web multiplexed in Istio"><meta name=twitter:description content="Expose GRPC & GRPC-Web via One Port in Istio"><meta property="og:title" content="GRPC & GRPC-Web multiplexed in Istio"><meta property="og:description" content="Expose GRPC & GRPC-Web via One Port in Istio"><meta property="og:type" content="article"><meta property="og:url" content="https://jackieli.dev/posts/grpc-web-istio/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-25T15:55:25+00:00"><meta property="article:modified_time" content="2022-03-25T15:55:25+00:00"><title>GRPC & GRPC-Web multiplexed in Istio · jackieli.dev</title><link rel=canonical href=https://jackieli.dev/posts/grpc-web-istio/><link rel=preload href="https://jackieli.dev/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://jackieli.dev/css/coder.min.34dfa7b2f5cdeb0f5302b2628f4a7a4bfe88a2431e1397ee4ec605c56ab69701.css integrity="sha256-NN+nsvXN6w9TArJij0p6S/6IokMeE5fuTsYFxWq2lwE=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://jackieli.dev/css/coder-dark.min.d8f89ef09509afb63b9b2595ee174e53cc51ce02a6f6a2179e1621f9389e4340.css integrity="sha256-2Pie8JUJr7Y7myWV7hdOU8xRzgKm9qIXnhYh+TieQ0A=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://jackieli.dev/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://jackieli.dev/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=https://jackieli.dev/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://jackieli.dev/images/apple-touch-icon.png><meta name=generator content="Hugo 0.98.0"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://jackieli.dev/>jackieli.dev</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://jackieli.dev/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://jackieli.dev/posts/>Posts</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://jackieli.dev/posts/grpc-web-istio/>GRPC & GRPC-Web multiplexed in Istio</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2022-03-25T15:55:25Z>25 Mar 2022</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
3-minute read</span></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i>
<a href=https://jackieli.dev/categories/grpc-web/>gRPC-Web</a></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=https://jackieli.dev/tags/istio/>istio</a></span>
<span class=separator>•</span>
<span class=tag><a href=https://jackieli.dev/tags/kubernetes/>kubernetes</a></span></div></div></header><div><p>Envoy had grpc-web support ealy on. It&rsquo;s used in the official grpc-web
<a href=https://github.com/grpc/grpc-web#2-run-the-server-and-proxy>tutorial docs</a>.
In the <a href=https://github.com/grpc/grpc-web/blob/8c5502186445e35002697f4bd8d1b820abdbed5d/net/grpc/gateway/examples/echo/envoy.yaml>envoy
config</a>
of this tutorial, both grpc & grpcWeb are exposed via a single <code>listener</code> port.
This is nice model when you have a production deployment in which some clients
(mobile apps) want to speak to the GRPC protocol directly, but web apps want to
go down to http/1.1 to work with browsers&rsquo; xhr or fetch requests.</p><p>In production, we use istio as our gateway, but we have always struggled to
utilise one single port to proxy both GRPC and GRPC-Web requests, even though
envoy - the underlying proxy supports it very well. I suppose it&rsquo;s partially
due to the lack of documentation out there and the GRPC-Web community is still
relatively small.</p><p>As we adopted Istio & GRPC-Web quite early on, we used what some other bloggers
suggested: using a sidecar to convert HTTP1.1 request to GRPC and use a
separate gateway dedicated to GRPC. The solution roughly looks like this:</p><p><strong>For grpc</strong></p><p><code>gateway:31400</code> -> <code>app</code></p><p><strong>For grpc-web</strong></p><p><code>gateway:443</code> -> <code>pod sidecar</code> -> <code>app</code></p><p>This has a few issues:</p><ol><li>We&rsquo;re adding an extra open port to outside world: more attacking surface</li><li>The new grpc-only port doesn&rsquo;t have TLS or needs a separate TLS config</li><li>We added a sidecar pod for every grpc service that we want to expose as
GRPC-Web: wasted resources when we don&rsquo;t need service mesh</li></ol><p>This is definitely not right when evnoy supports the use case so well, but why
does it feels so difficult on Istio&rsquo;s side?</p><p>I finally sat down today and look at this from scratch: We have an effective
envoy config, so we just need to configure istio such that the gateway envoy of
istio has the most important elements that supports both GRPC & GRPC-Web.
Namely:</p><ol><li>on the listener config we need the filter <a href=https://github.com/grpc/grpc-web/blob/8c5502186445e35002697f4bd8d1b820abdbed5d/net/grpc/gateway/examples/echo/envoy.yaml#L38>envoy.filters.http.grpc_web</a></li><li>on the clusters config we need the <a href=https://github.com/grpc/grpc-web/blob/8c5502186445e35002697f4bd8d1b820abdbed5d/net/grpc/gateway/examples/echo/envoy.yaml#L45>http2_protocol_options</a></li></ol><p>And we definitely don&rsquo;t need the sidecar for this: sidecar is for east-west
traffic, not north-south traffic. So the filter needs to be on the gateway, not
the sidecar.</p><p>Well, it turns out it&rsquo;s still in the same
<a href=https://istio.io/latest/docs/reference/config/networking/envoy-filter/>EnvoyFilter</a>
documentation. We just need to 1) configure the filter on the gateway; 2) use
<code>grpc-web</code> as the protocol in the service. (I believe <code>grpc</code> works just as
well)</p><h2 id=the-solution>The solution
<a class=heading-link href=#the-solution><i class="fa fa-link" aria-hidden=true></i></a></h2><p><code>gateway:443</code> -> <code>app</code> for both <code>grpc</code> & <code>grpc-web</code></p><p><strong>envoy filter</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=font-weight:700>apiVersion</span>: networking.istio.io/v1alpha3
</span></span><span style=display:flex><span><span style=font-weight:700>kind</span>: EnvoyFilter
</span></span><span style=display:flex><span><span style=font-weight:700>metadata</span>:
</span></span><span style=display:flex><span>  <span style=font-weight:700>name</span>: gateway-grpc-web-filter
</span></span><span style=display:flex><span>  <span style=font-weight:700>namespace</span>: istio-system
</span></span><span style=display:flex><span><span style=font-weight:700>spec</span>:
</span></span><span style=display:flex><span>  <span style=font-weight:700>workloadSelector</span>:
</span></span><span style=display:flex><span>    <span style=font-weight:700>labels</span>:
</span></span><span style=display:flex><span>      <span style=font-weight:700>istio</span>: ingressgateway
</span></span><span style=display:flex><span>  <span style=font-weight:700>configPatches</span>:
</span></span><span style=display:flex><span>    - <span style=font-weight:700>applyTo</span>: HTTP_FILTER
</span></span><span style=display:flex><span>      <span style=font-weight:700>match</span>:
</span></span><span style=display:flex><span>	  	<span style=font-style:italic># importantly we&#39;re patching to the GATEWAY envoy, not sidecar</span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>context</span>: GATEWAY
</span></span><span style=display:flex><span>        <span style=font-weight:700>listener</span>:
</span></span><span style=display:flex><span>          <span style=font-weight:700>filterChain</span>:
</span></span><span style=display:flex><span>            <span style=font-weight:700>filter</span>:
</span></span><span style=display:flex><span>              <span style=font-weight:700>name</span>: <span style=font-style:italic>&#34;envoy.filters.network.http_connection_manager&#34;</span>
</span></span><span style=display:flex><span>              <span style=font-weight:700>subFilter</span>:
</span></span><span style=display:flex><span>				<span style=font-style:italic># apply the patch before the cors filter, just like the one in</span>
</span></span><span style=display:flex><span>				<span style=font-style:italic># grpc-web example</span>
</span></span><span style=display:flex><span>                <span style=font-weight:700>name</span>: <span style=font-style:italic>&#34;envoy.filters.http.cors&#34;</span>
</span></span><span style=display:flex><span>      <span style=font-weight:700>patch</span>:
</span></span><span style=display:flex><span>        <span style=font-weight:700>operation</span>: INSERT_BEFORE
</span></span><span style=display:flex><span>        <span style=font-weight:700>value</span>:
</span></span><span style=display:flex><span>          <span style=font-weight:700>name</span>: envoy.filters.http.grpc_web
</span></span></code></pre></div><p><strong>virtual service</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=font-weight:700>apiVersion</span>: networking.istio.io/v1alpha3
</span></span><span style=display:flex><span><span style=font-weight:700>kind</span>: VirtualService
</span></span><span style=display:flex><span><span style=font-weight:700>metadata</span>:
</span></span><span style=display:flex><span>  <span style=font-weight:700>name</span>: hello-grpc
</span></span><span style=display:flex><span>  <span style=font-weight:700>namespace</span>: default
</span></span><span style=display:flex><span><span style=font-weight:700>spec</span>:
</span></span><span style=display:flex><span>  <span style=font-weight:700>hosts</span>:
</span></span><span style=display:flex><span>    - <span style=font-style:italic>&#34;*&#34;</span>
</span></span><span style=display:flex><span>  <span style=font-weight:700>gateways</span>:
</span></span><span style=display:flex><span>    - httpbin-gateway
</span></span><span style=display:flex><span>  <span style=font-weight:700>http</span>:
</span></span><span style=display:flex><span>    - <span style=font-weight:700>route</span>:
</span></span><span style=display:flex><span>        - <span style=font-weight:700>destination</span>:
</span></span><span style=display:flex><span>            <span style=font-weight:700>host</span>: hello-grpc
</span></span><span style=display:flex><span>            <span style=font-weight:700>port</span>:
</span></span><span style=display:flex><span>              <span style=font-weight:700>number</span>: 12345
</span></span><span style=display:flex><span>      <span style=font-weight:700>match</span>:
</span></span><span style=display:flex><span>        - <span style=font-weight:700>uri</span>:
</span></span><span style=display:flex><span>            <span style=font-weight:700>prefix</span>: /main.HelloService/
</span></span></code></pre></div><p>And importantly the service needs to have <code>grpc</code> in the service name or use
<code>appProtocol</code>:
<a href=https://istio.io/latest/docs/ops/configuration/traffic-management/protocol-selection/#explicit-protocol-selection>ref</a></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=font-weight:700>apiVersion</span>: v1
</span></span><span style=display:flex><span><span style=font-weight:700>kind</span>: Service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>metadata</span>:
</span></span><span style=display:flex><span>  <span style=font-weight:700>name</span>: hello-grpc
</span></span><span style=display:flex><span>  <span style=font-weight:700>namespace</span>: default
</span></span><span style=display:flex><span><span style=font-weight:700>spec</span>:
</span></span><span style=display:flex><span>  <span style=font-weight:700>selector</span>:
</span></span><span style=display:flex><span>    <span style=font-weight:700>app</span>: hello-grpc
</span></span><span style=display:flex><span>  <span style=font-weight:700>type</span>: LoadBalancer
</span></span><span style=display:flex><span>  <span style=font-weight:700>ports</span>:
</span></span><span style=display:flex><span>    - <span style=font-weight:700>name</span>: grpc <span style=font-style:italic># name has to start with grpc, alternatively use appProtocol below</span>
</span></span><span style=display:flex><span>      <span style=font-weight:700>port</span>: 12345
</span></span><span style=display:flex><span>      <span style=font-style:italic># or use appProtocol for Kubernetes 1.18+</span>
</span></span><span style=display:flex><span>      <span style=font-style:italic># appProtocol: grpc</span>
</span></span></code></pre></div><p>Full example on <a href=https://github.com/jackieli-tes/learn-grpc-web-istio>github</a>.
There are some useful debug commands that helped.</p></div><footer><script src=https://utteranc.es/client.js repo=jackielii/jackieli.dev issue-term=pathname label theme=github-light crossorigin=anonymous async></script></footer></article></section></div><footer class=footer><section class=container>©
2019 -
2022
Jackie Li
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=https://jackieli.dev/js/coder.min.8fb86376a16e684af472a329aef502dbebcfab65ce264e9750d144912947c602.js integrity="sha256-j7hjdqFuaEr0cqMprvUC2+vPq2XOJk6XUNFEkSlHxgI="></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-173573373-1","auto"),ga("send","pageview"))</script></body></html>