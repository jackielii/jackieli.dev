<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Jackie Li"><meta name=description content="Cel-go is an amazing library for evaluating expressions. The extensive proto support just makes it better.
Let&rsquo;s explore an interesting problem: if we were to build a evaluation service without embedding the actual proto, i.e. without bundling the generated code that defines the struct, fields etc, how can we still evaluate the expressions that requests the contents of the proto messages?
Let&rsquo;s start with this proto:
syntax = &#34;proto3&#34;;package main;option go_package = &#34;."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Use dynamic proto in cel-go"><meta name=twitter:description content="Cel-go is an amazing library for evaluating expressions. The extensive proto support just makes it better.
Let&rsquo;s explore an interesting problem: if we were to build a evaluation service without embedding the actual proto, i.e. without bundling the generated code that defines the struct, fields etc, how can we still evaluate the expressions that requests the contents of the proto messages?
Let&rsquo;s start with this proto:
syntax = &#34;proto3&#34;;package main;option go_package = &#34;."><meta property="og:title" content="Use dynamic proto in cel-go"><meta property="og:description" content="Cel-go is an amazing library for evaluating expressions. The extensive proto support just makes it better.
Let&rsquo;s explore an interesting problem: if we were to build a evaluation service without embedding the actual proto, i.e. without bundling the generated code that defines the struct, fields etc, how can we still evaluate the expressions that requests the contents of the proto messages?
Let&rsquo;s start with this proto:
syntax = &#34;proto3&#34;;package main;option go_package = &#34;."><meta property="og:type" content="article"><meta property="og:url" content="https://jackieli.dev/posts/use-dynamic-proto-in-cel-go/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-17T17:15:09+00:00"><meta property="article:modified_time" content="2022-03-17T17:15:09+00:00"><title>Use dynamic proto in cel-go Â· jackieli.dev</title><link rel=canonical href=https://jackieli.dev/posts/use-dynamic-proto-in-cel-go/><link rel=preload href="https://jackieli.dev/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://jackieli.dev/css/coder.min.d9fddbffe6f27e69985dc5fe0471cdb0e57fbf4775714bc3d847accb08f4a1f6.css integrity="sha256-2f3b/+byfmmYXcX+BHHNsOV/v0d1cUvD2Eesywj0ofY=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://jackieli.dev/css/coder-dark.min.002ee2378e14c7a68f1f0a53d9694ed252090987c4e768023fac694a4fc5f793.css integrity="sha256-AC7iN44Ux6aPHwpT2WlO0lIJCYfE52gCP6xpSk/F95M=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://jackieli.dev/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://jackieli.dev/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=https://jackieli.dev/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://jackieli.dev/images/apple-touch-icon.png><meta name=generator content="Hugo 0.99.1"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://jackieli.dev/>jackieli.dev</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://jackieli.dev/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://jackieli.dev/posts/>Posts</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://jackieli.dev/posts/use-dynamic-proto-in-cel-go/>Use dynamic proto in cel-go</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2022-03-17T17:15:09Z>17 Mar 2022</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
2-minute read</span></div></div></header><div><p><a href=https://github.com/google/cel-go>Cel-go</a> is an amazing library for evaluating
expressions. The extensive proto support just makes it better.</p><p>Let&rsquo;s explore an interesting problem: if we were to build a evaluation service
without embedding the actual proto, i.e. without bundling the generated code
that defines the struct, fields etc, how can we still evaluate the expressions
that requests the contents of the proto messages?</p><p>Let&rsquo;s start with this proto:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span>syntax = <span style=font-style:italic>&#34;proto3&#34;</span>;<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=font-weight:700>package</span> <span style=font-weight:700>main</span>;<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=font-weight:700>option</span> go_package = <span style=font-style:italic>&#34;.;main&#34;</span>;<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=font-weight:700>message</span> <span style=font-weight:700>Foo</span> {<span>
</span></span></span><span style=display:flex><span><span></span>  <span>string</span> foo = 1;<span>
</span></span></span><span style=display:flex><span><span></span>}<span>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=font-weight:700>func</span> messageBytes() []<span>byte</span> {
</span></span><span style=display:flex><span>	foo := &amp;Foo{Foo: <span style=font-style:italic>&#34;foo message&#34;</span>}
</span></span><span style=display:flex><span>	b, err := proto.Marshal(foo)
</span></span><span style=display:flex><span>	<span style=font-weight:700>if</span> err != <span style=font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		panic(err)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=font-weight:700>return</span> b
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>func</span> descBytes() []<span>byte</span> {
</span></span><span style=display:flex><span>	set := &amp;descriptorpb.FileDescriptorSet{
</span></span><span style=display:flex><span>		File: []*descriptorpb.FileDescriptorProto{
</span></span><span style=display:flex><span>			protodesc.ToFileDescriptorProto(File_foo_proto),
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	b, err := proto.Marshal(set)
</span></span><span style=display:flex><span>	<span style=font-weight:700>if</span> err != <span style=font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		panic(err)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=font-weight:700>return</span> b
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now if we know the bytes of <code>Foo</code> message using <code>messageBytes</code> and the proto
descriptor also in bytes (every generated code has it). Then we declare it as
var <code>x</code> and evaluate <code>x.foo</code>. And we should be able to get value <code>foo message</code>
right?</p><p>Turns out it&rsquo;s all supported within cel-go. We just register the all the file
descriptor related to message <code>foo</code> and use dynamic message to wrap the bytes:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=font-weight:700>func</span> exercise9() {
</span></span><span style=display:flex><span>	<span style=font-style:italic>// step 1: register the proto descriptors
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>	fileSet := &amp;descriptorpb.FileDescriptorSet{}
</span></span><span style=display:flex><span>	err := proto.Unmarshal(descBytes(), fileSet)
</span></span><span style=display:flex><span>	<span style=font-weight:700>if</span> err != <span style=font-weight:700>nil</span> { panic(err) }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	fooFullName := <span style=font-style:italic>&#34;main.Foo&#34;</span> <span style=font-style:italic>// `main` is the proto package name
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>	reg, err := protodesc.NewFiles(fileSet)
</span></span><span style=display:flex><span>	<span style=font-weight:700>if</span> err != <span style=font-weight:700>nil</span> { panic(err) }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=font-style:italic>// step 2: wrap it with dynamicpb message
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>	desc, err := reg.FindDescriptorByName(protoreflect.FullName(fooFullName))
</span></span><span style=display:flex><span>	<span style=font-weight:700>if</span> err != <span style=font-weight:700>nil</span> { panic(err) }
</span></span><span style=display:flex><span>	msg := dynamicpb.NewMessage(desc.(protoreflect.MessageDescriptor))
</span></span><span style=display:flex><span>	err = proto.Unmarshal(messageBytes(), msg.Interface())
</span></span><span style=display:flex><span>	<span style=font-weight:700>if</span> err != <span style=font-weight:700>nil</span> { panic(err) }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=font-style:italic>// step 3: cel magic
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>	env, _ := cel.NewEnv(
</span></span><span style=display:flex><span>		cel.TypeDescs(fileSet),
</span></span><span style=display:flex><span>		cel.Declarations(decls.NewVar(<span style=font-style:italic>&#34;x&#34;</span>, decls.NewObjectType(fooFullName))),
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	ast, iss := env.Compile(<span style=font-style:italic>`x.foo`</span>)
</span></span><span style=display:flex><span>	<span style=font-weight:700>if</span> iss.Err() != <span style=font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		glog.Exit(iss.Err())
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=font-style:italic>// Turn on optimization.
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>	vars := <span style=font-weight:700>map</span>[<span>string</span>]<span style=font-weight:700>interface</span>{}{<span style=font-style:italic>&#34;x&#34;</span>: msg}
</span></span><span style=display:flex><span>	program, _ := env.Program(ast, cel.EvalOptions(cel.OptExhaustiveEval))
</span></span><span style=display:flex><span>	eval(program, vars)
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=font-style:italic>// output: foo message
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>}
</span></span></code></pre></div><p>Full source at <a href=https://github.com/jackieli-tes/learn-cel-go>github</a></p></div><footer><script src=https://utteranc.es/client.js repo=jackielii/jackieli.dev issue-term=pathname label theme=github-light crossorigin=anonymous async></script></footer></article></section></div><footer class=footer><section class=container>Â©
2019 -
2022
Jackie Li
Â·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=https://jackieli.dev/js/coder.min.8fb86376a16e684af472a329aef502dbebcfab65ce264e9750d144912947c602.js integrity="sha256-j7hjdqFuaEr0cqMprvUC2+vPq2XOJk6XUNFEkSlHxgI="></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-173573373-1","auto"),ga("send","pageview"))</script></body></html>