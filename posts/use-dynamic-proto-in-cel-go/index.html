<!doctype html><html lang=en><head><title>Use dynamic proto in cel-go · jackieli.dev</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Jackie Li"><meta name=description content="Cel-go is an amazing library for evaluating expressions. The extensive proto support just makes it better.
Let&rsquo;s explore an interesting problem: if we were to build a evaluation service without embedding the actual proto, i.e. without bundling the generated code that defines the struct, fields etc, how can we still evaluate the expressions that requests the contents of the proto messages?
Let&rsquo;s start with this proto:
syntax = &#34;proto3&#34;; package main; option go_package = &#34;."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Use dynamic proto in cel-go"><meta name=twitter:description content="Cel-go is an amazing library for evaluating expressions. The extensive proto support just makes it better.
Let&rsquo;s explore an interesting problem: if we were to build a evaluation service without embedding the actual proto, i.e. without bundling the generated code that defines the struct, fields etc, how can we still evaluate the expressions that requests the contents of the proto messages?
Let&rsquo;s start with this proto:
syntax = &#34;proto3&#34;; package main; option go_package = &#34;."><meta property="og:title" content="Use dynamic proto in cel-go"><meta property="og:description" content="Cel-go is an amazing library for evaluating expressions. The extensive proto support just makes it better.
Let&rsquo;s explore an interesting problem: if we were to build a evaluation service without embedding the actual proto, i.e. without bundling the generated code that defines the struct, fields etc, how can we still evaluate the expressions that requests the contents of the proto messages?
Let&rsquo;s start with this proto:
syntax = &#34;proto3&#34;; package main; option go_package = &#34;."><meta property="og:type" content="article"><meta property="og:url" content="https://jackieli.dev/posts/use-dynamic-proto-in-cel-go/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-17T17:15:09+00:00"><meta property="article:modified_time" content="2022-03-17T17:15:09+00:00"><link rel=canonical href=https://jackieli.dev/posts/use-dynamic-proto-in-cel-go/><link rel=preload href="https://jackieli.dev/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://jackieli.dev/css/coder.min.135e22c97ff685fe983fc60048e309ced8f00d8d38f536aa67dba8a13a03dfa4.css integrity="sha256-E14iyX/2hf6YP8YASOMJztjwDY049TaqZ9uooToD36Q=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://jackieli.dev/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=https://jackieli.dev/images/favicon.svg sizes=any><link rel=icon type=image/png href=https://jackieli.dev/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://jackieli.dev/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=https://jackieli.dev/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://jackieli.dev/images/apple-touch-icon.png><link rel=manifest href=https://jackieli.dev/site.webmanifest><link rel=mask-icon href=https://jackieli.dev/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://jackieli.dev/>jackieli.dev</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://jackieli.dev/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://jackieli.dev/posts/>Posts</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://jackieli.dev/posts/use-dynamic-proto-in-cel-go/>Use dynamic proto in cel-go</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2022-03-17T17:15:09Z>17 Mar 2022</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
2-minute read</span></div></div></header><div class=post-content><p><a href=https://github.com/google/cel-go class=external-link target=_blank rel=noopener>Cel-go</a> is an amazing library for evaluating
expressions. The extensive proto support just makes it better.</p><p>Let&rsquo;s explore an interesting problem: if we were to build a evaluation service
without embedding the actual proto, i.e. without bundling the generated code
that defines the struct, fields etc, how can we still evaluate the expressions
that requests the contents of the proto messages?</p><p>Let&rsquo;s start with this proto:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-proto data-lang=proto><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kn>package</span> <span class=nn>main</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;.;main&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Foo</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>foo</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>messageBytes</span><span class=p>()</span> <span class=p>[]</span><span class=kt>byte</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>foo</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>Foo</span><span class=p>{</span><span class=nx>Foo</span><span class=p>:</span> <span class=s>&#34;foo message&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>b</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proto</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>foo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>b</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>descBytes</span><span class=p>()</span> <span class=p>[]</span><span class=kt>byte</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>set</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>descriptorpb</span><span class=p>.</span><span class=nx>FileDescriptorSet</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>File</span><span class=p>:</span> <span class=p>[]</span><span class=o>*</span><span class=nx>descriptorpb</span><span class=p>.</span><span class=nx>FileDescriptorProto</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>protodesc</span><span class=p>.</span><span class=nf>ToFileDescriptorProto</span><span class=p>(</span><span class=nx>File_foo_proto</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>b</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proto</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>set</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>b</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Now if we know the bytes of <code>Foo</code> message using <code>messageBytes</code> and the proto
descriptor also in bytes (every generated code has it). Then we declare it as
var <code>x</code> and evaluate <code>x.foo</code>. And we should be able to get value <code>foo message</code>
right?</p><p>Turns out it&rsquo;s all supported within cel-go. We just register the all the file
descriptor related to message <code>foo</code> and use dynamic message to wrap the bytes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>exercise9</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// step 1: register the proto descriptors
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fileSet</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>descriptorpb</span><span class=p>.</span><span class=nx>FileDescriptorSet</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>proto</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nf>descBytes</span><span class=p>(),</span> <span class=nx>fileSet</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span> <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fooFullName</span> <span class=o>:=</span> <span class=s>&#34;main.Foo&#34;</span> <span class=c1>// `main` is the proto package name
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>reg</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>protodesc</span><span class=p>.</span><span class=nf>NewFiles</span><span class=p>(</span><span class=nx>fileSet</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span> <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// step 2: wrap it with dynamicpb message
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>desc</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>reg</span><span class=p>.</span><span class=nf>FindDescriptorByName</span><span class=p>(</span><span class=nx>protoreflect</span><span class=p>.</span><span class=nf>FullName</span><span class=p>(</span><span class=nx>fooFullName</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span> <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>msg</span> <span class=o>:=</span> <span class=nx>dynamicpb</span><span class=p>.</span><span class=nf>NewMessage</span><span class=p>(</span><span class=nx>desc</span><span class=p>.(</span><span class=nx>protoreflect</span><span class=p>.</span><span class=nx>MessageDescriptor</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>proto</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nf>messageBytes</span><span class=p>(),</span> <span class=nx>msg</span><span class=p>.</span><span class=nf>Interface</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span> <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// step 3: cel magic
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>env</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>cel</span><span class=p>.</span><span class=nf>NewEnv</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>cel</span><span class=p>.</span><span class=nf>TypeDescs</span><span class=p>(</span><span class=nx>fileSet</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>cel</span><span class=p>.</span><span class=nf>Declarations</span><span class=p>(</span><span class=nx>decls</span><span class=p>.</span><span class=nf>NewVar</span><span class=p>(</span><span class=s>&#34;x&#34;</span><span class=p>,</span> <span class=nx>decls</span><span class=p>.</span><span class=nf>NewObjectType</span><span class=p>(</span><span class=nx>fooFullName</span><span class=p>))),</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>ast</span><span class=p>,</span> <span class=nx>iss</span> <span class=o>:=</span> <span class=nx>env</span><span class=p>.</span><span class=nf>Compile</span><span class=p>(</span><span class=s>`x.foo`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>iss</span><span class=p>.</span><span class=nf>Err</span><span class=p>()</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>glog</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=nx>iss</span><span class=p>.</span><span class=nf>Err</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Turn on optimization.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>vars</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;x&#34;</span><span class=p>:</span> <span class=nx>msg</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>program</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>env</span><span class=p>.</span><span class=nf>Program</span><span class=p>(</span><span class=nx>ast</span><span class=p>,</span> <span class=nx>cel</span><span class=p>.</span><span class=nf>EvalOptions</span><span class=p>(</span><span class=nx>cel</span><span class=p>.</span><span class=nx>OptExhaustiveEval</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nf>eval</span><span class=p>(</span><span class=nx>program</span><span class=p>,</span> <span class=nx>vars</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=c1>// output: foo message
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>Full source at <a href=https://github.com/jackieli-tes/learn-cel-go class=external-link target=_blank rel=noopener>github</a></p></div><footer><div class=comments><script>let getTheme=window.localStorage&&window.localStorage.getItem("colorscheme");getTheme=getTheme??"preferred_color_scheme";let s=document.createElement("script");s.src="https://giscus.app/client.js",s.setAttribute("data-repo","jackielii/jackieli.dev"),s.setAttribute("data-repo-id","MDEwOlJlcG9zaXRvcnkyNzM3MjUxODQ="),s.setAttribute("data-category","General"),s.setAttribute("data-category-id","MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMzMDU5OTk0"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-term",""),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","bottom"),s.setAttribute("data-theme",getTheme),s.setAttribute("data-lang","en"),s.setAttribute("data-loading",""),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></footer></article></section></div><footer class=footer><section class=container>©
2019 -
2023
Jackie Li
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=https://jackieli.dev/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-173573373-1","auto"),ga("send","pageview"))</script></body></html>